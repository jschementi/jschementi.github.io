---
title: "IronRuby @ RubyConf 2009 – Part 3.5: Embedding IronRuby"
layout: "post"
permalink: "/2009/12/ironruby-rubyconf-2009-part-35.html"
uuid: "4847271533064123372"
guid: "tag:blogger.com,1999:blog-5419182.post-4847271533064123372"
date: "2009-12-15 06:29:00"
updated: "2009-12-15 23:59:38"
description: 
blogger:
    siteid: "5419182"
    postid: "4847271533064123372"
    comments: "2"
categories: [Embedding, IronRuby, rubyconf]
author: 
    name: "Jimmy Schementi"
    url: "https://plus.google.com/116380716127564408544?rel=author"
    image: "//lh6.googleusercontent.com/-Fl3zUgl9dMw/AAAAAAAAAAI/AAAAAAAABYQ/CvQezyGiMP4/s512-c/photo.jpg"
---

<div class="post-content">
<p><em>This is part of a <a href="http://blog.jimmy.schementi.com/search/label/rubyconf">RubyConf 2009 series</a>:</em>     <br /><a href="http://blog.jimmy.schementi.com/2009/12/ironruby-rubyconf-2009-part-1-summary.html">Overview</a> | <a href="http://blog.jimmy.schementi.com/2009/12/ironruby-rubyconf-2009-part-2-what-sets.html">What sets IronRuby apart?</a> | <a href="http://blog.jimmy.schementi.com/2009/12/ironruby-rubyconf-part-3-sneaking-ruby.html">Sneaking Ruby to the top</a> / <strong>Embedding IronRuby</strong> | <a href="http://blog.jimmy.schementi.com/2009/12/ironruby-rubyconf-2009-part-4-project.html">Project status</a></p>  <p>Imagine you’re building a program to help create animations, visualizations, and other interactive applications. The requirements are simple:</p>  <ol>   <li>2D rendering surface with simple primitive shapes </li>    <li>Simple animation support – callbacks for each frame and each object on the canvas </li>    <li>User-loadable “macros” for drawing and animating </li> </ol>  <p>A .NET developer can easily code up the first two requirements in C#, but implementing the third will be tricky. What does a macro look like? How do I discover them? How can I make it interactive? Why is this so hard!? This scenario requires the user to input some data, and the program must make an animation out of it; the data of your program is the code. Here are the options most .NET developers would come up with:</p>  <ul>   <li>Domain specific language – people usually cop out here and make it XML-based, which happens to produce the most human-unreadable code ever. This DSL <em>could</em> also be GUI-based, but you won’t get any programmers interesting in extending your app that way. </li>    <li>Completely punt on the interactivity and require the macros be .NET DLLs. </li>    <li>Find a way to use C# interactively - either using <a href="http://msdn.microsoft.com/en-us/library/650ax5cx.aspx" target="_blank">CodeDom</a> to compile and run C# code dynamically (much like ASP.NET does), or code-generate a valid C# class from the snippet, compile it to a DLL (aka shell out to csc.exe), loading that DLL, and finally reflecting over that DLL to call the user’s code. This is, of course, ignoring the question of whether C# is a good macro language or not. <em>It’s worth noting that Mono supports </em><a href="http://www.go-mono.com/docs/index.aspx?link=N:Mono.CSharp" target="_blank"><em>hosting</em></a><em> it’s C# compiler, so you could do more dynamic things with C# through Mono.</em> </li> </ul>  <p>Given all that talk about Ruby before, let’s try using IronRuby to write these macros. Here’s a C# app to start from:</p>  <p><a href="http://lh5.ggpht.com/_OqCZhp9yI0Q/SycsxGvRmmI/AAAAAAAAAOo/rh-7Yk3_YoM/s1600-h/image%5B7%5D.png" target="_blank"><img style="border-right-width: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; margin-left: auto; border-left-width: 0px; margin-right: auto" title="image" border="0" alt="image" src="http://lh4.ggpht.com/_OqCZhp9yI0Q/SycsxnTO4RI/AAAAAAAAAOs/SbrR43DWA3s/image_thumb%5B6%5D.png?imgmax=800" width="400" height="200" /></a> </p>  <p align="center"><a href="http://github.com/jschementi/rubyconf2009/tree/sketchscript-part1" target="_blank">SketchScript starter on GitHub</a> (<a href="http://github.com/jschementi/rubyconf2009/zipball/sketchscript-part1" target="_blank">zip</a>)</p>  <p align="center"><em>For the lazy, <a href="http://github.com/jschementi/rubyconf2009/tree/master/sketchscript" target="_blank">get the finished app’s source code</a> (<a href="http://github.com/jschementi/rubyconf2009/zipball/master" target="_blank">zip</a>), and a <font color="#ff0000">binary build (coming soon)</font>.</em></p>  <p>The starter app does ABSOLUTELY NOTHING; just a Window with a <a href="http://msdn.microsoft.com/en-us/library/system.windows.controls.canvas(VS.100).aspx" target="_blank">Canvas</a> and a bunch of textboxes for coding. Keep in mind this is just a demonstration, and this app could have been written entirely in Ruby, but the point is to show .NET developers how powerful an embedded scripting language can be.</p>  <h4><font color="#ff8000">Setting up your environment</font></h4>  <p>.NET developers have choices for development environments: mainly <a href="http://www.microsoft.com/visualstudio" target="_blank">Visual Studio</a> or <a href="http://www.icsharpcode.net/OpenSource/SD/" target="_blank">SharpDevelop</a>, or even the command-line and text-editor (I left out <a href="http://monodevelop.com/" target="_blank">MonoDevelop</a> since Mono doesn’t support the Windows UI stuff I’m doing, but a future version will be able to run in Mono). I’ll be using <a href="http://download.microsoft.com/download/1/3/1/1316A924-AF88-4CC9-9661-CD1D2BBF3E5E/vs_proweb.exe" target="_blank">Visual Studio 2010 Beta 2</a> for this walkthrough’s screenshots and examples, specifically because it C# 4 has special dynamic language features,<strike> but you can also use C# 3 with Visual Studio 2008 (</strike><a href="http://www.microsoft.com/express/vcsharp/#webInstall" target="_blank"><strike>free version here</strike></a><strike>),</strike> or just stick to a text-editor and <a href="http://en.wikipedia.org/wiki/MSBuild" target="_blank">MSBuild</a>.</p>  <p>If you’re using .NET 4.0, <code>sketchscript\sketchscript.sln</code> is the solution file you want to use. <strike>The .NET 3.5 version is <code>sketchscript\sketchscript3.5.sln</code>, but seriously, try out .NET 4.0</strike>.</p>  <p><em><font color="#ff0000">I haven’t tested it out in VS2008 yet, so please bare with me. If you’re feeling adventurous, you can fork my git repo, get it working in VS2008, and I’ll pull your changes in.</font></em></p>  <h4><font color="#ff8000">Adding references to IronRuby</font></h4>  <p>If you downloaded SketchScript from the above link, you’ll find four DLLs required for embedding IronRuby in the <code>sketchscript\ironruby</code> directory. Add those as references to the sketchscript.csproj:</p>  <p><a href="http://lh6.ggpht.com/_OqCZhp9yI0Q/Sycsx3szVGI/AAAAAAAAAOw/11s_xD274X8/s1600-h/image%5B8%5D.png" target="_blank"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://lh6.ggpht.com/_OqCZhp9yI0Q/SycsySkF0tI/AAAAAAAAAO0/G6YqFDt8y84/image_thumb%5B7%5D.png?imgmax=800" width="285" height="225" /></a> </p>  <p>In case you’re curious about what each DLL is: <code>IronRuby.dll</code> is the IronRuby compiler, while <code>IronRuby.Libraries.dll</code> is the core libraries of Ruby. <code>Microsoft.Dynamic.dll</code> are the APIs that IronRuby depend on for DLR compiler features, and <code>Microsoft.Scripting.dll</code> is the DLR Hosting API.</p>  <p><em>If anyone who has used IronRuby before is thinking there are missing DLLs, then you’re right. IronRuby’s <code>Microsoft.Scripting.Core.dll</code> has been integrated into .NET 4.0 as the new <code>System.Core.dll</code>. This also removes the need for <code>Microsoft.Scripting.ExtensionAttribute.dll</code>.</em></p>  <h4><font color="#ff8000">Embedding IronRuby</font></h4>  <p>Now let’s get that code window working; first add some <code>using</code> statements at the top of <a href="http://github.com/jschementi/rubyconf2009/blob/3db197e19f75832822e28811de90a76bd426cf40/sketchscript/sketchscript/MainWindow.xaml.cs#L19" target="_blank">MainWindow.xaml.cs</a>:</p> <script src="http://gist.github.com/255762.js?file=MainWindow-usings.xaml.cs"></script>  <p>And some fields to hold onto the scripting engine anywhere in the <code>MainWindow</code> class:</p> <script src="http://gist.github.com/255762.js?file=MainWindow-fields.xaml.cs"></script>  <p>Now initialize the scripting engine; add this code to the <code>Loaded</code> event action, after setting the <code>OutputBuffer</code> but before the <code>KeyBindings()</code> call (around line 71):</p> <script src="http://gist.github.com/255762.js?file=MainWindow-Loaded.xaml.cs"></script>  <p>And lastly let’s run the code when Ctrl-Enter is pressed. Since that’s already set up for us, all we need to do is add this code in the <code>RunCode</code> method, right at the &quot;TODO&quot; comment around line 92:</p> <script src="http://gist.github.com/255762.js?file=MainWindow-RunCode.xaml.cs"></script>  <p>And that’s it! Now you’ll be able to run some actual Ruby code:</p>  <p><a href="http://lh5.ggpht.com/_OqCZhp9yI0Q/SycsyiiHxJI/AAAAAAAAAO8/6xVCyHphKOc/s1600-h/image%5B9%5D.png" target="_blank"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://lh5.ggpht.com/_OqCZhp9yI0Q/Sycsy8GOyTI/AAAAAAAAAPI/gEuDPxBZi9c/image_thumb%5B8%5D.png?imgmax=800" width="400" height="331" /></a></p>  <h4><font color="#ff8000">Interacting with the host application</font></h4>  <p>Though Ruby code can run, there is no obvious interaction with the host application. That black void of a canvas on the left would be completely useless if it wasn’t accessible from Ruby code, so add this single line to the <code>Loaded</code> event action, before the <code>KeyBinding()</code> call:</p> <script src="http://gist.github.com/255762.js?file=MainWindow-expose.xaml.cs"></script>  <blockquote>   <p><em>Note: if the host application didn’t do this, it would still be possible to get to the canvas from Ruby code, but the script writer would have to do it themselves:</em></p>   <script src="http://gist.github.com/255885.js?file=without-host-help.rb"></script>    <p><em>So, as a general rule-of-thumb, have your host program decide what parts to extend to script code, and have the script code only use that object-model, though their may be ways around it.</em></p> </blockquote>  <h4><font color="#ff8000">Trying it out</font></h4>  <p>Now that there’s a way to draw on the canvas, play around with drawing random things on the screen. Here’s a little script I’ve been playing with:</p> <script src="http://gist.github.com/255885.js?file=lots-o-squares.rb"></script>  <p>Which draws this:</p>  <p><a href="http://lh6.ggpht.com/_OqCZhp9yI0Q/SycszJJagnI/AAAAAAAAAPQ/1GpBiNQWFcc/s1600-h/squares%5B3%5D.jpg" target="_blank"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="squares" border="0" alt="squares" src="http://lh5.ggpht.com/_OqCZhp9yI0Q/SycszvE7NSI/AAAAAAAAAPY/teqQBnaIJkI/squares_thumb%5B2%5D.jpg?imgmax=800" width="400" height="445" /></a> </p>  <p>Ooo, pretty! So without much effort we have a very extendable application. Before you get carried away playing around with making pretty things, there’s one more thing to do to make this app really awesome …</p>  <h4><font color="#ff8000">Animation support</font></h4>  <p>While animations could still be built with IronRuby’s native thread support or <a href="http://msdn.microsoft.com/en-us/library/ms752312.aspx" target="_blank">WPF animations</a> directly from Ruby code, it’d be nice for the host to provide some simple animation support, like a callback that fires for every frame, and even a way to attach animations to any object.</p>  <p>The <a href="http://github.com/jschementi/rubyconf2009/blob/sketchscript-basicembed/sketchscript/sketchscript/MainWindow.xaml.cs#L158" target="_blank">host currently supports these two callbacks</a>, but they need to be wired up. Add the following code at the bottom of the <code>Loaded</code> event action, before the call to <code>KeyBindings()</code>: </p> <script src="http://gist.github.com/255762.js?file=MainWindow-RegisterCallback.xaml.cs"></script>  <p>And also add this call at the end of the <code>RunCode</code> method:</p> <script src="http://gist.github.com/255762.js?file=MainWindow-CaptureCallbacks.xaml.cs"></script>  <p>Lastly we need to implement <code>CatureAnimationCallbacks</code>, by looking for special method names to get a hold of. Look for <code>each_frame</code> as the <code>EachFrame</code> action, and <code>each_object</code> as the <code>EachObject</code> func.</p> <script src="http://gist.github.com/255762.js?file=MainWindow-CaptureCallbackImpl.xaml.cs"></script>  <p>Now 30-times-a-second the host will try to call <code>each_frame</code>, and it will call <code>each_object</code> once for each element on the canvas, store the return value on the actual element, and then try to call an <code>update</code> method on that stored object 30-times-a-second. This lets you either run random animations, or specific behavior for objects.</p>  <p>A good animation example is bouncing, so let's run the script that produced all the squares first, and then run the following code to make them all bounce.</p> <script src="http://gist.github.com/255885.js?file=bounce.rb"></script>  <p>And now it should look something like this:</p> <object width="400" height="300"><param name="allowfullscreen" value="true" /><param name="allowscriptaccess" value="always" /><param name="movie" value="http://vimeo.com/moogaloop.swf?clip_id=8185302&amp;server=vimeo.com&amp;show_title=1&amp;show_byline=1&amp;show_portrait=0&amp;color=&amp;fullscreen=1" /><embed src="http://vimeo.com/moogaloop.swf?clip_id=8185302&amp;server=vimeo.com&amp;show_title=1&amp;show_byline=1&amp;show_portrait=0&amp;color=&amp;fullscreen=1" type="application/x-shockwave-flash" allowfullscreen="true" allowscriptaccess="always" width="400" height="300"></embed></object>  <p>There are more goodies to run in the <a href="http://github.com/jschementi/rubyconf2009/tree/master/sketchscript/features" target="_blank">features directory</a>, but try writing your own fun little animations. <a href="http://blog.jredville.com" target="_blank">Jim Deville</a> ported <a href="http://github.com/jcasimir/code_of_art/raw/master/documents/Code%20of%20Art%20-%20Tutorial.pdf" target="_blank">the tutorial</a> from <a href="http://github.com/jcasimir" target="_blank">Jeff Casimir’s</a> <a href="http://github.com/jcasimir/code_of_art" target="_blank">Code of Art</a> talk, which is pretty fun to play with, so if you make your own please post a comment with a screenshot and code!</p>  <p><a href="http://github.com/jschementi/rubyconf2009/blob/master/sketchscript/features/circles.rb" target="_blank"><strong>circle.rb</strong></a></p>  <p><a href="http://lh5.ggpht.com/_OqCZhp9yI0Q/Sycszz0ew-I/AAAAAAAAAPg/HPMRUr-U4OI/s1600-h/artclear2%5B2%5D.png" target="_blank"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="artclear2" border="0" alt="artclear2" src="http://lh3.ggpht.com/_OqCZhp9yI0Q/Sycs0eNOBVI/AAAAAAAAAPw/16GTRLcFXE4/artclear2_thumb%5B1%5D.png?imgmax=800" width="400" height="444" /></a>&#160;</p>  <p>And there you have it, IronRuby embedded to do interesting things. In case you missed any steps along the way, <a href="http://gist.github.com/256632" target="_blank">here's the full diff</a> against the initial download.</p>  <p><font color="#ff8000"><strong>Next stop, <a href="http://blog.jimmy.schementi.com/2009/12/ironruby-rubyconf-2009-part-4-project.html">IronRuby’s status and roadmap</a>.</strong></font></p>  
</div>