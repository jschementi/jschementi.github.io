---
title: "MIX10, Part 3 - Using dynamic languages in existing web-applications"
layout: "post"
permalink: "/2010/04/mix10-part-3-using-dynamic-languages-in.html"
uuid: "6639078554962062655"
guid: "tag:blogger.com,1999:blog-5419182.post-6639078554962062655"
date: "2010-04-27 10:19:00"
updated: "2010-07-19 10:19:59"
description: 
blogger:
    siteid: "5419182"
    postid: "6639078554962062655"
    comments: "1"
categories: [MIX10, Testing, Embedding, Dynamic Languages, talks, IronRuby, IronPython]
author: 
    name: "Jimmy Schementi"
    url: "https://plus.google.com/116380716127564408544?rel=author"
    image: "//lh6.googleusercontent.com/-Fl3zUgl9dMw/AAAAAAAAAAI/AAAAAAAABYQ/CvQezyGiMP4/s512-c/photo.jpg"
---

<div class="css-full-post-content js-full-post-content">
<div style="border-bottom: #666 5px solid; border-left: #666 5px solid; padding-bottom: 5px; background-color: #333; margin: 0px 0px 10px; padding-left: 5px; padding-right: 5px; color: white; border-top: #666 5px solid; border-right: #666 5px solid; padding-top: 5px">   <p style="padding-bottom: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px" class="section"><em>This post is part of the “MIX10 – Pumping Iron on the web” series:</em></p>    <ul style="padding-bottom: 0px; margin: 0px 0px 0px 20px; padding-left: 0px; padding-right: 0px; padding-top: 0px">     <li><a href="http://blog.jimmy.schementi.com/2010/03/mix10-ironruby-and-ironpython-part-1.html">Part 1 - Introduction</a> </li>      <li><a href="http://blog.jimmy.schementi.com/2010/04/mix10-part-21-server-side-web.html">Part 2.1 – Server-side web development with dynamic languages</a> </li>      <li><a href="http://blog.jimmy.schementi.com/2010/04/mix10-part-22-client-side-web.html">Part 2.2 – Client-side web development with dynamic languages</a> </li>      <li><strong>Part 3 - Using scripting in static applications </strong></li>      <li><em>Coming soon: </em>Part 4 - Web-app extensibility with scripts </li>   </ul> </div>  <blockquote>   <p><em>The original post was mistakenly removed, so it’s been reposted with the original post date, 4/27/2010. Sorry if this confuses your blog readers or causes any other inconvenience.</em></p> </blockquote>  <p>Up until now I've discussed how to use dynamic languages to power both the server-side as well as the client-side of your web-application, but what if you want to apply these methods to solve certain problems in an existing application?</p>  <h4><font color="#ff8000"><strong>Testing</strong></font></h4>  <p>A low-risk, high-benefit use of dynamic languages in your existing applications is for testing. This helps make the act of writing tests simpler, and quite possibly more fun, encouraging your team to actually maintain the test suite.</p>  <p>Before looking at how to test web-apps, let's take a brief look at what a test written with <a href="http://rspec.info/" target="_blank">RSpec</a>, a popular Ruby testing framework, looks like:</p> <script src="http://gist.github.com/481156.js?file=rspec.rb"></script>  <blockquote>   <p><strong>Note</strong>: there are Ruby testing frameworks that look a bit more like what you might be used to. The following is an equivalent test written with test/unit, and this will give you a better idea of the structure of the above example:</p>   <script src="http://gist.github.com/481156.js?file=testunit.rb"></script></blockquote>  <p>The RSpec snippet almost reads like english, making it very clear what the intended behavior of Stack is. Also, it shows the power of Ruby for creating internal DSLs; a &quot;language&quot; built out of the constructs of an existing language. <code>describe</code> and <code>it</code> look like language keywords, but in-fact they are really just methods, because Ruby has optional parameters (<a href="http://blog.jimmy.schementi.com/2010/04/mix10-part-21-server-side-web.html" target="_blank">as we discovered earlier with Sinatra</a>). Using actual strings as the test name, rather than a method name, allows you to describe the test accurately. Each object has a <code>should</code> method which makes any subsequent calls part of an assertion, making it very obvious which value is the &quot;expected&quot; value and which is the &quot;actual&quot;.</p>  <p>The crazy thing is how little code is required to make that work; <strong><font color="#ff8000">24 lines of Ruby</font></strong>. The key points are that <code>yield</code> executes the <code>do-end</code> block passed to a method, and the <code>should</code> method is added to every object, turning any subsequent methods calls into an assertion:</p> <script src="http://gist.github.com/481156.js?file=test-spec.rb"></script>  <p>However, please don't use this example as your real testing framework, and then get mad at me when it doesn't have a feature you want; <a href="http://rspec.info/" target="_blank">RSpec</a>, <a href="http://github.com/chneukirchen/bacon" target="_blank">Bacon</a>, or <a href="http://test-spec.rubyforge.org" target="_blank">test/spec</a> are much more mature testing frameworks that support this same syntax.</p>  <p><a href="http://blog.jimmy.schementi.com/2009/03/testing-c-silverlight-apps-with.html" target="_blank">See my previous post about using IronRuby to test C# Silverlight applications</a>; it’s still relevant though it’s a fairly old post.</p>  <h4><strong><font color="#ff8000">Hosting</font></strong></h4>  <p>IronRuby and IronPython are built on-top of the <a href="http://dlr.codeplex.com" target="_blank">Dynamic Language Runtime</a>, which is comprised of many parts, one of which being a <strong><a href="http://dlr.codeplex.com/Project/Download/FileDownload.aspx?DownloadId=127516" target="_blank">.NET Hosting API</a></strong>, allowing you to embed a scripting language in any .NET app.</p>  <p><font color="#ff8000"><strong>Now we come to the &quot;ah-ha!&quot; moment of the talk</strong></font>; <strong>everything</strong> you've seen in the <a href="http://blog.jimmy.schementi.com/search/label/MIX10" target="_blank">MIX10 posts</a> is made possible by this API. Keep in mind these languages are built <em>on</em> .NET, so their implementations are accessible from any .NET language. C# and VB today are not built on .NET; they just compile programs to run on .NET, which is why you can't easily host those languages today.</p>  <p>Here's the catch; since these language engines are built on .NET, they need to run <em>in</em> a .NET application. So, <strong>all</strong> Ruby or Python code runs by hosting the languages inside a .NET application. We do things to make this seamless in specific environments: for example, <tt>ir.exe</tt> and <tt>ipy.exe</tt> are both .NET programs which host the language and run the code in a command-line, mimicking the behavior of ruby.exe and python.exe. Here are some other popular hosts:</p>  <ul>   <li><tt>ipyw.exe</tt>: runs scripts in a console-less program for Windows applications </li>    <li><tt>Microsoft.Scripting.Silverlight.dll</tt>: entry-point for Silverlight applications which run HTML script tags and scripts inside the XAP </li>    <li><tt>IronRuby.Rack.dll</tt>: run rack-based applications on IIS </li>    <li><tt>Microsoft.Web.Scripting.dll</tt>: run Python in ASP.NET </li>    <li><tt>System.Web.Mvc.IronRuby</tt>: run Ruby in ASP.NET MVC </li> </ul>  <p>However, we can't provide &quot;runners&quot; for every environment that will spring up, so we allow you to use the same APIs that these runners use in your own apps. These APIs have been kept very simple, as we want any .NET developer to be able to use a DLR scripting language in their applications.</p>  <p><strong><font color="#ff8000">But why embed a scripting language into your application?</font></strong> The main scenario is to scripts as an extensibility mechanism, either internally or as functionality you provide for your end-users. Here are a few concrete examples of what scripts could be used for:</p>  <ul>   <li>An advanced search/filter (letting users use LINQ safely) </li>    <li>High-level business logic to computing prices of items, applying discounts, etc; any type of rules engine </li>    <li>A system which changes behavior based on external data </li>    <li>Customizing a single codebase for different clients </li>    <li>Add-ons for end-users to make your application better (eg. Facebook) </li>    <li>Making application logic simpler to read than the core of your system (polyglot) </li> </ul>  <p>Let's show you how to do the basics, and hopefully that will spark your imagine to think up other cool use-cases:</p>  <ol>   <li>Create a new web application project in Visual Studio 2010, and open the Default.aspx.cs page. </li>    <li>Place a label on the page and call it “Message”. </li>    <li>Add references to the necessary DLLs to host IronPython (IronPython.dll and Microsoft.Scripting.dll) </li>    <li>Write the 5 lines of code to update the label’s text from Python: </li> </ol> <script src="http://gist.github.com/481156.js?file=hosting.cs"></script>  <p>There are basically three types you need to know; <code>ScriptRuntime</code>, <code>ScriptEngine</code>, and <code>ScriptScope</code>.</p>  <ul>   <li>     <p><code>ScriptRuntime</code> is a level of encapsulation for your scripts; it represents the DLR scripting runtime, and all script operations go through it.</p>   </li>    <li>     <p><code>ScriptEngine</code> is the type that is returned from <code>ScriptRuntime.GetEngine</code>; it represents a DLR-language. In this case, we asked for the language by name, as that's the easiest way to keep it easily configurable, but the downside is you need language configuration info in your <code>App.config</code>. However, if you only want to depend on IronPython, you can use <code>IronPython.Hosting.Python.CreateEngine()</code>, which does all the setup for Python for you.</p>      <p>The <code>ScriptEngine</code> enabled you to execute code in that language, in a variety of ways, from the basic <code>engine.Execute</code> method (essentally <code>eval</code>), or being more fine-grained <code>engine.CreateScriptSourceFromString(code).Compile().Execute()</code>, which parses the file, compiles it, and then executes it. Code can be executed against a <code>ScriptScope</code> to set initial state and share state between executions.</p>   </li>    <li>     <p><code>ScriptScope</code> defines the state for your script; like what variables/methods are present. It is a dynamic object, so you can do things like <code>scope.page = this</code>, and that will set the <code>page</code> variable for scripts that execute against the scope. In downlevel .NET frameworks, you'd have to use <code>scope.SetVariable(page, this)</code>.</p>   </li> </ul>  <p><em>Slight aside</em>: since these APIs are .NET based, the dynamic languages themselves can consume them to run other dynamic languages! For example, here's Ruby executing Python code through the <a href="http://dlr.codeplex.com" target="_blank">DLR</a> Hosting APIs:</p> <script src="http://gist.github.com/481156.js?file=ruby-host-python.rb"></script>  <p>What's also interesting is the dynamic languages can communicate between <strong>each-other</strong> just as easily; here's Ruby calling Python code:</p> <script src="http://gist.github.com/481156.js?file=foo.py"></script><script src="http://gist.github.com/481156.js?file=bar.rb"></script>  <p>Anyway, hopefully this sparks some creativity! For more web-related information, also posted about this in relation to Silverlight applications: <a href="http://blog.jimmy.schementi.com/2009/03/scripting-c-silverlight-apps-with.html" target="_blank">Scripting C# apps with IronPython</a>.</p>  <p>The next post will show some cool applications of this … (<em>coming soon</em>).</p>  
</div>
<div class="css-full-comments-content js-full-comments-content">
<div class="css-full-comment js-full-comment">
  <div class="css-comment-user-link js-comment-user-link">
  <a href="http://www.youpixel.it/">
  <div class="css-comment-name js-comment-name">
    paolo
  </div>
  </a>
  <div class="css-comment-date js-comment-date">
    2011-10-09T13:00:10.532Z
  </div>
  </div>
  <div class="css-comment-content js-comment-content">
    ok thanks
  </div>
  <br/>
</div>
</div>